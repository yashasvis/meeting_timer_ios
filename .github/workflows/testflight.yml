name: iOS TestFlight

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-upload:
    runs-on: macos-14

    steps:
      # 1️⃣ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Configure access to private GitHub packages
      - name: Configure Git for private packages
        run: |
          git config --global url."https://${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}:@github.com/".insteadOf "https://github.com/"

      # 3️⃣ Set up Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.6"

      # 4️⃣ Install Flutter dependencies
      - name: Install dependencies
        run: flutter pub get

      # 5️⃣ Install provisioning profile
      - name: Install provisioning profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp ios/profiles/Meeting_Timer_App_Store.mobileprovision \
            ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Verify provisioning profile installed
        run: ls -la ~/Library/MobileDevice/Provisioning\ Profiles

      # 6️⃣ Import iOS signing certificate & provisioning profile
      - name: Import signing certificate & provisioning profile
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.IOS_CERTIFICATE }}
          p12-password: ${{ secrets.KEYCHAIN_PASSWORD }}
          provisioning-profile-base64: ${{ secrets.IOS_PROVISION_PROFILE }}

      # Create IPA folder (ensures directory exists)
      - name: Create IPA output folder
        run: |
          mkdir -p build/ios/ipa
          echo "IPA folder created at build/ios/ipa"
          ls -la build/ios

      # 7️⃣ Build IPA (App Store)
      - name: Build IPA archive
        run: |
          flutter build ipa --release 
          echo "Archive built at build/ios/archive/Runner.xcarchive"
          ls -la build/ios/archive

      # 9️⃣ Upload to TestFlight
      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: build/ios/ipa/Runner.ipa   # Adjust if your IPA has a different name
          api-key-id: ${{ secrets.APP_STORE_API_KEY_ID }}
          api-issuer-id: ${{ secrets.APP_STORE_API_ISSUER_ID }}
          api-private-key: ${{ secrets.APP_STORE_API_PRIVATE_KEY }}
