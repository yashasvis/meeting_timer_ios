name: iOS TestFlight

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-upload:
    runs-on: macos-14

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configure access to private GitHub packages
      - name: Configure Git for private packages
        run: |
          git config --global url."https://${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}:@github.com/".insteadOf "https://github.com/"

      # 3Ô∏è‚É£ Set up Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.6"

      # 4Ô∏è‚É£ Install Flutter dependencies
      - name: Install dependencies
        run: flutter pub get

      # 5Ô∏è‚É£ Install provisioning profile
      - name: Install provisioning profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp ios/profiles/Meeting_Timer_App_Store.mobileprovision \
            ~/Library/MobileDevice/Provisioning\ Profiles/
            
      - name: Verify provisioning profile exists
        run: |
          if [ -f ~/Library/MobileDevice/Provisioning\ Profiles/Meeting_Timer_App_Store.mobileprovision ]; then
            echo "‚úÖ Provisioning profile exists"
          else
            echo "‚ùå Provisioning profile NOT found"
            exit 1
          fi

      - name: Verify provisioning profile installed
        run: ls -la ~/Library/MobileDevice/Provisioning\ Profiles

      # 6Ô∏è‚É£ Import iOS signing certificate & provisioning profile
      - name: Import signing certificate & provisioning profile
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.IOS_CERTIFICATE }}
          p12-password: ${{ secrets.KEYCHAIN_PASSWORD }}
          provisioning-profile-base64: ${{ secrets.IOS_PROVISION_PROFILE }}

      - name: Make signing keychain default
        run: |
          security list-keychains -d user -s \
            "$HOME/Library/Keychains/signing_temp.keychain-db" \
            "$HOME/Library/Keychains/login.keychain-db"
      
          security default-keychain -s \
            "$HOME/Library/Keychains/signing_temp.keychain-db"
      
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" \
            "$HOME/Library/Keychains/signing_temp.keychain-db"

      - name: Verify signing identity
        run: |
          security find-identity -v -p codesigning

      - name: Import provisioning profile
        uses: apple-actions/import-provisioning-profile@v3
        with:
          provisioning-profile-base64: ${{ secrets.IOS_PROVISION_PROFILE }}
      
      # Create IPA folder (ensures directory exists)
      - name: Build iOS archive
        run: |
          flutter build ipa --no-codesign
          ARCHIVE_PATH="build/ios/archive/Runner.xcarchive"
          if [ -d "$ARCHIVE_PATH" ]; then
            echo "‚úÖ Archive created at $ARCHIVE_PATH"
            ls -la "$ARCHIVE_PATH"
          else
            echo "‚ùå Archive NOT found!"
            exit 1
          fi
          
      - name: Build iOS IPA
        run: |
          flutter build ipa --release
          IPA_PATH="build/ios/ipa/Runner.ipa"
          if [ -f "$IPA_PATH" ]; then
            echo "‚úÖ IPA created at $IPA_PATH"
          else
            echo "‚ùå IPA NOT found!"
            exit 1
          fi

      - name: Debug Bundle ID and Provisioning Profile
        shell: bash
        run: |
          echo "=============================="
          echo "üì¶ Bundle ID used in archive"
          echo "=============================="
      
          /usr/libexec/PlistBuddy -c "Print :ApplicationProperties:CFBundleIdentifier" \
            build/ios/archive/Runner.xcarchive/Info.plist || echo "‚ùå Archive not found"
      
          echo ""
          echo "=============================="
          echo "üìÑ Provisioning profile details"
          echo "=============================="
      
          PROFILE_PATH="$HOME/Library/MobileDevice/Provisioning Profiles/Meeting_Timer_App_Store.mobileprovision"
      
          if [ ! -f "$PROFILE_PATH" ]; then
            echo "‚ùå Provisioning profile not found at:"
            echo "$PROFILE_PATH"
            exit 1
          fi
      
          security cms -D -i "$PROFILE_PATH" > profile.plist
      
          echo ""
          echo "üîë application-identifier (TeamID.BundleID)"
          /usr/libexec/PlistBuddy -c "Print :Entitlements:application-identifier" profile.plist
      
          echo ""
          echo "üöÄ Distribution type checks"
          echo -n "get-task-allow: "
          /usr/libexec/PlistBuddy -c "Print :Entitlements:get-task-allow" profile.plist
      
          echo ""
          echo -n "ProvisionedDevices: "
          /usr/libexec/PlistBuddy -c "Print :ProvisionedDevices" profile.plist || echo "None (expected for App Store)"
      
          echo ""
          echo "=============================="

      - name: Debug build folder
        run: |
          echo "Current directory: $(pwd)"
          echo "Listing root folder:"
          ls -la
          echo "Listing build folder:"
          ls -la build
          echo "Listing iOS archive folder:"
          ls -la build/ios/archive
      
      # 8Ô∏è‚É£ Upload to TestFlight using the archive
      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: build/ios/archive/Runner.xcarchive
          api-key-id: ${{ secrets.APP_STORE_API_KEY_ID }}
          api-issuer-id: ${{ secrets.APP_STORE_API_ISSUER_ID }}
          api-private-key: ${{ secrets.APP_STORE_API_PRIVATE_KEY }}
