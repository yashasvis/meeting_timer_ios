name: iOS TestFlight

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-upload:
    runs-on: macos-14

    steps:
      # 1️⃣ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Configure access to private GitHub packages
      - name: Configure Git for private packages
        run: |
          git config --global url."https://${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}:@github.com/".insteadOf "https://github.com/"

      # 3️⃣ Set up Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.6"

      # 4️⃣ Install Flutter dependencies
      - name: Install dependencies
        run: flutter pub get

      # 5️⃣ Install provisioning profile
      - name: Install provisioning profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp ios/profiles/Meeting_Timer_App_Store.mobileprovision \
            ~/Library/MobileDevice/Provisioning\ Profiles/
            
      - name: Verify provisioning profile exists
        run: |
          if [ -f ~/Library/MobileDevice/Provisioning\ Profiles/Meeting_Timer_App_Store.mobileprovision ]; then
            echo "✅ Provisioning profile exists"
          else
            echo "❌ Provisioning profile NOT found"
            exit 1
          fi

      - name: Verify provisioning profile installed
        run: ls -la ~/Library/MobileDevice/Provisioning\ Profiles

      # 6️⃣ Import iOS signing certificate & provisioning profile
      - name: Import signing certificate & provisioning profile
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.IOS_CERTIFICATE }}
          p12-password: ${{ secrets.KEYCHAIN_PASSWORD }}
          provisioning-profile-base64: ${{ secrets.IOS_PROVISION_PROFILE }}

      # Create IPA folder (ensures directory exists)
      - name: Create IPA output folder
        run: |
          mkdir -p build/ios/ipa
          echo "✅ IPA folder created at build/ios/ipa"
          
          # Verify folder exists
          if [ -d build/ios/ipa ]; then
            echo "✅ Verified: build/ios/ipa exists"
            ls -la build/ios/ipa
          else
            echo "❌ build/ios/ipa was NOT created"
            exit 1
          fi

     # 7️⃣ Build archive (no codesign)
      - name: Build iOS IPA
        run: |
          flutter build ipa --release 
      
          # Check if IPA was created
          IPA_PATH="build/ios/ipa/Runner.ipa"
          
          if [ -f "$IPA_PATH" ]; then
            echo "✅ IPA successfully created at $IPA_PATH"
            ls -la build/ios/ipa
          else
            echo "❌ IPA NOT found! Build may have failed."
            ls -la build/ios/ipa
            exit 1
          fi

      - name: Debug build folder
        run: |
          echo "Current directory: $(pwd)"
          echo "Listing root folder:"
          ls -la
          echo "Listing build folder:"
          ls -la build
          echo "Listing iOS archive folder:"
          ls -la build/ios/archive
      
      # 8️⃣ Upload to TestFlight using the archive
      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: build/ios/archive/Runner.xcarchive
          api-key-id: ${{ secrets.APP_STORE_API_KEY_ID }}
          api-issuer-id: ${{ secrets.APP_STORE_API_ISSUER_ID }}
          api-private-key: ${{ secrets.APP_STORE_API_PRIVATE_KEY }}
